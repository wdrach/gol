<html>
  <head>
    <title>Game of Life</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
  </head>

  <body>
    <main></main>
    <script>
      const COMPRESSION_FACTOR = 4;
      const MINI_SIZE = 16;
      const FULL_SIZE = MINI_SIZE * COMPRESSION_FACTOR;
      const SCALE = 40;
      const SEED_DEPTH = 2;
      const SIM_DEPTH = 8;
      const matrix = [];
      function setup() {
        createCanvas(MINI_SIZE * SCALE, MINI_SIZE * SCALE);
        frameRate(5);
        for (let i = 0; i < SIM_DEPTH; i++) {
          // 1 for each color
          matrix.push([]);

          for (let j = 0; j < FULL_SIZE; j++) {
            matrix[i].push([]);

            for (let k = 0; k < FULL_SIZE; k++) {
              matrix[i][j].push(
                Math.floor(Math.random() * SEED_DEPTH) === 0 ? 1 : 0
              );
            }
          }
        }
      }

      function draw() {
        clear();

        // one for each sim
        // tick all of the simulations forward
        for (let ci = 0; ci < SIM_DEPTH; ci++) {
          const newMatrix = [];
          for (let i = 0; i < FULL_SIZE; i++) {
            newMatrix.push([]);
            for (let j = 0; j < FULL_SIZE; j++) {
              const cell = matrix[ci][i][j];

              let up = j - 1;
              let down = j + 1;
              let left = i - 1;
              let right = i + 1;

              if (up === -1) up = FULL_SIZE - 1;
              else if (down === FULL_SIZE) down = 0;

              if (left === -1) left = FULL_SIZE - 1;
              else if (right === FULL_SIZE) right = 0;

              let count = 0;
              if (matrix[ci][left][up]) count++;
              if (matrix[ci][i][up]) count++;
              if (matrix[ci][right][up]) count++;
              if (matrix[ci][left][j]) count++;
              if (matrix[ci][right][j]) count++;
              if (matrix[ci][left][down]) count++;
              if (matrix[ci][i][down]) count++;
              if (matrix[ci][right][down]) count++;

              if (count < 2) newMatrix[i].push(0);
              else if (count > 3) newMatrix[i].push(0);
              else if (count === 3) newMatrix[i].push(1);
              else newMatrix[i].push(cell);
            }
          }

          matrix[ci] = newMatrix;
        }

        // yellow - between red and green
        // red and green - always separate
        // blue - in line with red

        // 4 width rectangles, 3 "lines"
        // Red - sits between 0 and 5
        // Yellow - sits between 3 and 8, shift +/- 1
        // Green - sits between 6 and 11

        // looking at 2 things
        // 1: height - total / 2
        // 2: adjustment - odd / even
        for (let i = 0; i < MINI_SIZE; i++) {
          for (let j = 0; j < MINI_SIZE; j++) {
            let c = [0, 0, 0, 0];
            let d = [0, 0, 0, 0];
            for (let x = 0; x < COMPRESSION_FACTOR; x++) {
              for (let y = 0; y < COMPRESSION_FACTOR; y++) {
                const xCoord = i + x * MINI_SIZE;
                const yCoord = j + y * MINI_SIZE;

                const yellow = matrix[0][xCoord][yCoord];
                const red = matrix[1][xCoord][yCoord];
                const blue = matrix[2][xCoord][yCoord];
                const green = matrix[3][xCoord][yCoord];

                c[0] += yellow;
                c[1] += red;
                c[2] += blue;
                c[3] += green;

                const yellowEnabled = matrix[4][xCoord][yCoord];
                const redEnabled = matrix[5][xCoord][yCoord];
                const blueEnabled = matrix[6][xCoord][yCoord];
                const greenEnabled = matrix[7][xCoord][yCoord];

                d[0] += yellowEnabled;
                d[1] += redEnabled;
                d[2] += blueEnabled;
                d[3] += greenEnabled;
              }
            }

            for (const val in c) {
              if (d[val] < 2) break;
              const total = c[val];
              let offset = 0;
              switch (val) {
                case "0":
                  fill(color("rgba(252, 223, 82, .5)"));
                  break;
                case "1":
                  fill(color("rgba(197, 7, 35, .5)"));
                  offset = -SCALE / 3;
                  break;
                case "2":
                  fill(color("rgba(14, 124, 197, .5)"));
                  offset = -SCALE / 3;
                  break;
                case "3":
                  fill(color("rgba(58, 123, 52, .5)"));
                  offset = SCALE / 3;
                  break;
              }
              noStroke();

              for (let o = 0; o < total / 2; o++) {
                square(
                  i * SCALE + (total % 2) + offset,
                  (j + (total % 3)) * SCALE + (o * SCALE) / 2,
                  SCALE / 2,
                  SCALE / 8
                );
              }
            }
          }
        }
      }
    </script>
  </body>
</html>
